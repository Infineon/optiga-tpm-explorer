<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>AWS IoT Embedded C Device SDK: PortingGuide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AWS IoT Embedded C Device SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">PortingGuide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>#Porting Guide</p>
<h2>Scope</h2>
<p>The scope of this document is to provide instructions to modify the provided source files and functions in this SDK to run in a variety of embedded Câ€“based environments (e.g. real-time OS, embedded Linux) and to be adjusted to use a specific TLS implementation as available with specific hardware platforms.</p>
<h2>Contents of the SDK</h2>
<p>The SDK ported for linux can be downloaded from the below links.</p><ul>
<li><a href="https://s3.amazonaws.com/aws-iot-device-sdk-embedded-c/linux_mqtt_openssl-1.1.2.tar">OpenSSL</a></li>
<li><a href="https://s3.amazonaws.com/aws-iot-device-sdk-embedded-c/linux_mqtt_mbedtls-1.1.2.tar">mbedTLS from ARM</a></li>
</ul>
<p>The C-code files of this SDK are delivered via the following directory structure (see comment behind folder name for an explanation of its content).</p>
<p>Directory structure Current SDK Directory Layout (OpenSSL)</p>
<p>|&ndash;<code>aws_iot_src</code> (Source files of the AWS IoT device SDK)<br />
 |&ndash;<code>aws_mqtt_embedded_client_lib</code> (MQTT library based on <a href="http://www.eclipse.org/paho/clients/c/embedded/">Eclipse Paho</a> Embedded C client)<br />
 |&ndash;<code>certs</code> (Private key, device certificate and Root CA) <br />
 |&ndash;<code>docs</code> (Developer guide &amp; API documentation) <br />
 |&ndash;<code>sample_apps</code> (makefiles to build sample on openSSL) <br />
</p>
<p>Current SDK Directory Layout (mbedTLS)</p>
<p>|&ndash;<code>aws_iot_src</code> (Source files of the AWS IoT device SDK) <br />
 |&ndash;<code>aws_mqtt_embedded_client_lib</code> (MQTT library based on <a href="http://www.eclipse.org/paho/clients/c/embedded/">Eclipse Paho</a> Embedded C client) <br />
 |&ndash;<code>certs</code> (Private key, device certificate and Root CA) <br />
 |&ndash;<code>docs</code> (Developer guide &amp; API documentation) <br />
 |&ndash;<code>mbedtls_lib</code> (mbedTLS implementation library) <br />
 |&ndash;<code>sample_apps</code> (makefiles to build sample on mbedTLS) <br />
</p>
<p>All makefiles in this SDK were configured using the documented folder structure above, so moving or renaming folders will require modifications to makefiles.</p>
<h2>Explanation of folders and their content</h2>
<p><code>aws_iot_src</code> : This directory contains the SDK source code including wrappers around the MQTT library, device shadow code and utilities.</p>
<p><code>aws_mqtt_embedded_client_lib</code> : The source code for the Embedded C MQTT client. This client is a modified version of the <a href="http://www.eclipse.org/paho/clients/c/embedded/">Eclipse Paho</a> Embedded C client. The modifications include improved keep alive handling (callback on disconnect), a fix for unsubscribe functionality, buffer protection against too large MQTT messages and additional callback context to allow for a better layered architecture of the AWS IoT SDK.</p>
<p><code>certs</code> : This directory is initially empty and will need to contain the private key, the client certificate and the root CA. The client certificate and private key can be downloaded from the AWS IoT console or be created using the AWS CLI commands. The root CA can be downloaded from <a href="https://www.symantec.com/content/en/us/enterprise/verisign/roots/VeriSign-Class%203-Public-Primary-Certification-Authority-G5.pem">Symantec</a>.</p>
<p><code>docs</code> : SDK API and file documentation.</p>
<p><code>mbedtls_lib</code> : The mbedTLS source files. This directory is included when downloading the mbedTLS version of the SDK. It contains the mbedTLS source files to be built into the device application.</p>
<p><code>sample_apps</code> : This directory contains sample applications as well as their makefiles. These makefiles include the relevant source files in the above two directories. The samples include a simple MQTT example which publishes and subscribes to the AWS IoT service as well as a device shadow example that shows example usage of the device shadow functionality.</p>
<h2>Integrating the SDK into your environment</h2>
<p>This section explains the API calls that need to be implemented in order for the Device SDK to run on your platform. The SDK interfaces follow the driver model where only prototypes are defined by the Device SDK itself while the implementation is delegated to the user of the SDK to adjust it to the platform in use. The following sections list the needed functionality for the device SDK to run successfully on any given platform.</p>
<h3><a class="el" href="structTimer.html">Timer</a> Functions</h3>
<p>A timer implementation is necessary to handle request timeouts (sending MQTT connect, subscribe, etc. commands) as well as connection maintenance (MQTT keep-alive pings). Timers need millisecond resolution and are polled for expiration so these can be implemented using a "milliseconds since startup" free-running counter if desired. In the synchronous sample provided with this SDK only one command will be "in flight" at one point in time plus the client's ping timer.</p>
<p>Define the <code><a class="el" href="structTimer.html">Timer</a></code> Struct as in <code><a class="el" href="timer__linux_8h.html">timer_linux.h</a></code></p>
<p><code>void <a class="el" href="timer__interface_8h.html#a79820bfaea999f86b108701af73dd68e" title="Initialize a timer. ">InitTimer(Timer*)</a>;</code> InitTimer - A timer structure is initialized to a clean state.</p>
<p><code>char <a class="el" href="timer__interface_8h.html#adf4838ca0d96f6dbf45c99756731542d" title="Check if a timer is expired. ">expired(Timer*)</a>;</code> expired - a poling function to determine if the timer has expired.</p>
<p><code>void <a class="el" href="timer__interface_8h.html#a346afafb170b78f813bf7a15e4f2aede" title="Create a timer (milliseconds) ">countdown_ms(Timer*, unsigned int)</a>;</code> countdown_ms - set the timer to expire in x milliseconds and start the timer.</p>
<p><code>void <a class="el" href="timer__interface_8h.html#acc8817569e64e1d4193b08ca2570517a" title="Create a timer (seconds) ">countdown(Timer*, unsigned int)</a>;</code> countdown - set the timer to expire in x seconds and start the timer.</p>
<p><code>int <a class="el" href="timer__interface_8h.html#a81352d29dba5f9e360b6f551b33475c6" title="Check the time remaining on a give timer. ">left_ms(Timer*)</a>;</code> left_ms - query time in milliseconds left on the timer.</p>
<h3><a class="el" href="structNetwork.html" title="Network Structure. ">Network</a> Functions</h3>
<p>In order for the MQTT client stack to be able to communicate via the TCP/IP network protocol stack using a mutually authenticated TLS connection, the following API calls need to be implemented for your platform.</p>
<p>For additional details about API parameters refer to the <a href="http://aws-iot-device-sdk-embedded-c-docs.s3-website-us-east-1.amazonaws.com/index.html">API documentation</a>.</p>
<p><code>int <a class="el" href="network__interface_8h.html#ab17c9e7cec3c8d74bf338d18dd77fe83" title="Initialize the TLS implementation. ">iot_tls_init(Network *pNetwork)</a>;</code> Initialize the network client / structure.</p>
<p><code>int <a class="el" href="network__interface_8h.html#af3b017dbd1b7f3c84815dc6211c60284" title="Create a TLS socket and open the connection. ">iot_tls_connect(Network *pNetwork, TLSConnectParams TLSParams)</a>;</code> Create a TLS TCP socket to the configure address using the credentials provided via the NewNetwork API call. This will include setting up certificate locations / arrays.</p>
<p><code>int <a class="el" href="network__interface_8h.html#a5ff537ba2223e211242e82e6582ab103" title="Read bytes from the network socket. ">iot_tls_read(Network*, unsigned char*, int, int)</a>;</code> Read from the TLS network buffer.</p>
<p><code>int <a class="el" href="network__interface_8h.html#affa29ed55e598ac01574f863ddceae66" title="Write bytes to the network socket. ">iot_tls_write(Network*, unsigned char*, int, int)</a>;</code> Write to the TLS network buffer.</p>
<p><code>void <a class="el" href="network__interface_8h.html#ad85769916d75a8bb778cdf2126dd4f02" title="Disconnect from network socket. ">iot_tls_disconnect(Network *pNetwork)</a>;</code> Disconnect API</p>
<p><code>int <a class="el" href="network__interface_8h.html#a4d1624f588b2b18cd6d0d6974cb741d4" title="Perform any tear-down or cleanup of TLS layer. ">iot_tls_destroy(Network *pNetwork)</a>;</code> Clean up the connection</p>
<p>The TLS library generally provides the API for the underlying TCP socket.</p>
<h3>Sample Porting:</h3>
<p>Marvell has ported the SDK to its IoT Starter kit. <a href="https://github.com/marvell-iot/aws_starter_sdk/tree/master/wmsdk/external/aws_iot/aws_iot_src/protocol/mqtt/aws_iot_embedded_client_wrapper/platform_wmsdk">These</a> files are example implementations of the above mentioned functions.</p>
<h2>Time source for certificate validation</h2>
<p>As part of the TLS handshake the device (client) needs to validate the server certificate which includes validation of the certificate lifetime requiring that the device is aware of the actual time. Devices should be equipped with a real time clock or should be able to obtain the current time via NTP. Bypassing validation of the lifetime of a certificate is not recommended as it exposes the device to a security vulnerability, as it will still accept server certificates even when they have already expired.</p>
<h2>Integration into operating system</h2>
<h3>Single-Threaded implementation</h3>
<p>The single threaded implementation implies that the sample application code (SDK + MQTT client) is called periodically by the firmware application running on the main thread. This is done by calling the function <code>aws_iot_mqtt_yield</code> (in the simple pub-sub example) and by calling <code><a class="el" href="aws__iot__shadow__interface_8h.html#a0c5d153544c57027f0f802bf29376f87" title="Yield function to let the background tasks of MQTT and Shadow. ">aws_iot_shadow_yield()</a></code> (in the device shadow example). In both cases the keep-alive time is set to 10 seconds. This means that the yield functions need to be called at a minimum frequency of once every 10 seconds. Note however that the <code>iot_mqtt_yield()</code> function takes care of reading incoming MQTT messages from the IoT service as well and hence should be called more frequently depending on the timing requirements of an application. All incoming messages can only be processed at the frequency at which <code>yield</code> is called.</p>
<h3>Multi-Threaded implementation</h3>
<p>In the simple multithreaded case the <code>yield</code> function can be moved to a background thread. Ensure this task runs at the frequency described above. In this case, depending on the OS mechanism, a message queue or mailbox could be used to proxy incoming MQTT messages from the callback to the worker task responsible for responding to or dispatching messages. A similar mechanism could be employed to queue publish messages from threads into a publish queue that are processed by a publishing task. Ensure a synchronization primitive like mutex is used, as the library is not thread safe.</p>
<h2>Sample applications</h2>
<p>The sample apps in this SDK provide a working implementation for either openSSL or mbedTLS, meaning that the function calls explained above are already implemented for these TLS libraries for linux.</p>
<h3>Memory Requirements</h3>
<p>These numbers do not include TLS and TCP/IP code. This is just the AWS IoT SDK.</p>
<h4>Marvell Example</h4>
<p>The following sizes are of AWS IoT sample compiled for <a href="https://github.com/marvell-iot/aws_starter_sdk">Marvell AWS IoT</a> platform. </p><h5>Size of Certificates</h5>
<ul>
<li>Private key - 1733 bytes</li>
<li>Signed Certificate from AWS IoT - 1225 bytes</li>
<li>Root CA - 1680 bytes</li>
</ul>
<h5>Size of SDK with MQTT subscribe publish sample</h5>
<p>All sizes are in bytes</p>
<table class="doxtable">
<tr>
<th>Name </th><th>Text </th><th>RO Data </th><th>Data </th><th>BSS </th><th>Common </th><th>Total  </th></tr>
<tr>
<td>MQTT Buffer: 512 bytes </td><td>4436 </td><td>304 </td><td>1 </td><td>1200 </td><td>0 </td><td>5941 </td></tr>
<tr>
<td>MQTT Buffer: 256 bytes </td><td>4436 </td><td>304 </td><td>1 </td><td>688 </td><td>0 </td><td>5429 </td></tr>
</table>
<h5>Size of SDK with Shadow sample</h5>
<p>All sizes are in bytes</p>
<table class="doxtable">
<tr>
<th>Name </th><th>Text </th><th>RO Data </th><th>Data </th><th>BSS </th><th>Common </th><th>Total  </th></tr>
<tr>
<td>Shadow Sample with default <code><a class="el" href="aws__iot__config_8h.html" title="AWS IoT specific configuration file. ">aws_iot_config.h</a></code> values </td><td>9016 </td><td>618 </td><td>2 </td><td>7792 </td><td>0 </td><td>17428 </td></tr>
<tr>
<td>Shadow Sample with reduced JSON keys and less number of message handling at any given time </td><td>9020 </td><td>618 </td><td>2 </td><td>5322 </td><td>0 </td><td>14962 </td></tr>
</table>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
